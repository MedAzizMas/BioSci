<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Alignment - BioSci AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/protein.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 3Dmol.js for protein visualization -->
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
</head>

<body class="protein-page">

    <!-- Particle Background Canvas -->
    <canvas id="particleCanvas"></canvas>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="{{ url_for('home') }}" class="brand">
                <img src="https://r.mobirisesite.com/2107618/assets/images/photo-1738082956242-d897b9177bba.jpeg"
                    alt="BioSci Logo" style="border-radius: 50%;">
                BioSci
            </a>
            <div class="nav-links">
                <a href="{{ url_for('home') }}" class="nav-link">Home</a>
                <a href="{{ url_for('home') }}#features" class="nav-link">About</a>
                <a href="{{ url_for('home') }}#contact" class="nav-link">Contact</a>
            </div>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </button>
            <button class="mobile-toggle" aria-label="Toggle Navigation">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="protein-main">
        <div class="protein-container">
            <!-- Sidebar -->
            <aside class="protein-sidebar">
                <div class="sidebar-section">
                    <h3><i class="fas fa-info-circle"></i> About This Tool</h3>
                    <p class="sidebar-text">Compare protein sequences between Human and Klebsiella pneumoniae using ESM-2 embeddings and Smith-Waterman alignment.</p>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-lightbulb"></i> Example Proteins</h3>
                    <div class="example-proteins">
                        <button class="example-btn" data-human="tr|A0A024RA31|A0A024RA31_HUMAN" data-bacteria="tr|A0A0C7KF14|A0A0C7KF14_KLEPN">
                            Example Pair 1
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-cog"></i> Pipeline Info</h3>
                    <ul class="info-list">
                        <li><span class="info-label">Model:</span> ESM-2 150M</li>
                        <li><span class="info-label">Chunk Length:</span> 10 aa</li>
                        <li><span class="info-label">Chunk Stride:</span> 5 aa</li>
                        <li><span class="info-label">LLM:</span> Llama 3.3 70B</li>
                    </ul>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="protein-content">
                <div class="page-header">
                    <h1><i class="fas fa-microscope"></i> Protein Alignment Analysis</h1>
                    <p>ESM-2 Embedding-Based Alignment with LLM Interpretation</p>
                </div>

                <!-- Input Form -->
                <div class="form-container">
                    <form id="alignmentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="humanProtein"><i class="fas fa-user"></i> Human Protein ID</label>
                                <div class="input-with-button">
                                    <input type="text" id="humanProtein" name="humanProtein" 
                                           placeholder="e.g., tr|A0A024RA31|A0A024RA31_HUMAN" required>
                                    <button type="button" class="btn-3d" onclick="view3DStructure('human')" title="View 3D Structure">
                                        <i class="fas fa-cube"></i>
                                    </button>
                                </div>
                                <small id="humanStatus" class="status-text"></small>
                            </div>
                            <div class="form-group">
                                <label for="bacteriaProtein"><i class="fas fa-bacterium"></i> Bacterial Protein ID</label>
                                <div class="input-with-button">
                                    <input type="text" id="bacteriaProtein" name="bacteriaProtein" 
                                           placeholder="e.g., tr|A0A0C7KF14|A0A0C7KF14_KLEPN" required>
                                    <button type="button" class="btn-3d" onclick="view3DStructure('bacteria')" title="View 3D Structure">
                                        <i class="fas fa-cube"></i>
                                    </button>
                                </div>
                                <small id="bacteriaStatus" class="status-text"></small>
                            </div>
                        </div>

                        <div class="options-row">
                            <label class="checkbox-label">
                                <input type="checkbox" id="computeFunctional" checked>
                                <span>Compute Functional Annotations</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="useLLM" checked>
                                <span>Generate LLM Interpretation</span>
                            </label>
                        </div>

                        <button type="submit" id="submitBtn" class="btn btn-primary submit-btn">
                            <i class="fas fa-flask"></i> Analyze Alignment
                        </button>
                    </form>
                </div>

                <!-- Progress Section -->
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div class="progress-header">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Analysis in Progress...</h3>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div id="progressBar" class="progress-bar-fill"></div>
                    </div>
                    <p id="progressText" class="progress-text">Initializing...</p>
                    <p class="progress-note">First run may take 5-8 minutes (ESM-2 model download). Subsequent runs: ~1-2 minutes.</p>
                </div>

                <!-- Error Section -->
                <div id="errorContainer" class="error-container" style="display: none;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                    <p id="errorText"></p>
                </div>

                <!-- Results Preview -->
                <div id="resultsPreview" class="results-preview" style="display: none;">
                    <h2><i class="fas fa-check-circle"></i> Analysis Complete</h2>
                    <div id="summaryContent" class="summary-content"></div>
                    <div class="results-actions">
                        <button onclick="viewFullResults()" class="btn btn-primary">
                            <i class="fas fa-eye"></i> View Detailed Results
                        </button>
                        <button onclick="downloadResults()" class="btn btn-secondary">
                            <i class="fas fa-download"></i> Download JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 3D Structure Modal -->
    <div id="structureModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cube"></i> <span id="modalTitle">3D Protein Structure</span></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="structureLoading" class="structure-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading structure from AlphaFold...</p>
                </div>
                <div id="structureError" class="structure-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <p id="structureErrorText"></p>
                </div>
                <div id="viewer3d" class="viewer-3d" style="display: none;"></div>
                <div id="structureInfo" class="structure-info" style="display: none;">
                    <div class="info-row">
                        <span class="info-label">Protein:</span>
                        <span id="infoProteinName" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Organism:</span>
                        <span id="infoOrganism" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">UniProt ID:</span>
                        <span id="infoUniprotId" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Source:</span>
                        <span id="infoSource" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Avg pLDDT:</span>
                        <span id="infoPlddtScore" class="info-value"></span>
                    </div>
                    <div class="plddt-legend">
                        <span class="legend-title">pLDDT Confidence:</span>
                        <div class="legend-scale">
                            <span class="legend-item"><span class="color-box" style="background: #0053D6;"></span> Very High (>90)</span>
                            <span class="legend-item"><span class="color-box" style="background: #65CBF3;"></span> High (70-90)</span>
                            <span class="legend-item"><span class="color-box" style="background: #FFDB13;"></span> Low (50-70)</span>
                            <span class="legend-item"><span class="color-box" style="background: #FF7D45;"></span> Very Low (<50)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetView()">
                    <i class="fas fa-undo"></i> Reset View
                </button>
                <button class="btn btn-secondary" onclick="toggleSpin()">
                    <i class="fas fa-sync"></i> Toggle Spin
                </button>
                <button class="btn btn-primary" onclick="closeModal()">
                    <i class="fas fa-check"></i> Done
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container footer-content">
            <div class="footer-brand">
                <h3>BioSci</h3>
                <p class="copyright">Â© 2024 BioSci AI. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/particles.js') }}"></script>
    <script src="{{ url_for('static', filename='js/protein.js') }}"></script>
</body>

</html>
