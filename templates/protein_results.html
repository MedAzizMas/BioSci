<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alignment Results - BioSci AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/protein.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 3Dmol.js for protein visualization -->
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
</head>

<body class="protein-page">

    <!-- Particle Background Canvas -->
    <canvas id="particleCanvas"></canvas>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="{{ url_for('home') }}" class="brand">
                <img src="https://r.mobirisesite.com/2107618/assets/images/photo-1738082956242-d897b9177bba.jpeg"
                    alt="BioSci Logo" style="border-radius: 50%;">
                BioSci
            </a>
            <div class="nav-links">
                <a href="{{ url_for('home') }}" class="nav-link">Home</a>
                <a href="{{ url_for('protein') }}" class="nav-link">Protein Alignment</a>
                <a href="{{ url_for('home') }}#contact" class="nav-link">Contact</a>
            </div>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </button>
            <button class="mobile-toggle" aria-label="Toggle Navigation">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="protein-main results-main">
        <div class="results-container">
            <div class="results-header">
                <h1><i class="fas fa-dna"></i> Alignment Results</h1>
                <a href="{{ url_for('protein') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> New Analysis
                </a>
            </div>

            <!-- Protein Info Cards -->
            <section class="results-section">
                <h2>Protein Information</h2>
                <div class="protein-cards">
                    <div class="protein-card human">
                        <h3><i class="fas fa-user"></i> Human Protein</h3>
                        <p><strong>ID:</strong> {{ results.input_sequences.human.protein_id }}</p>
                        <p><strong>Length:</strong> {{ results.input_sequences.human.length_aa }} aa</p>
                        <p><strong>Chunks:</strong> {{ results.input_sequences.human.num_chunks }}</p>
                        <button class="btn btn-3d-small" onclick="view3DStructure('{{ results.input_sequences.human.protein_id }}', 'Human')">
                            <i class="fas fa-cube"></i> View 3D Structure
                        </button>
                    </div>
                    <div class="protein-card bacteria">
                        <h3><i class="fas fa-bacterium"></i> Bacterial Protein</h3>
                        <p><strong>ID:</strong> {{ results.input_sequences.bacteria.protein_id }}</p>
                        <p><strong>Length:</strong> {{ results.input_sequences.bacteria.length_aa }} aa</p>
                        <p><strong>Chunks:</strong> {{ results.input_sequences.bacteria.num_chunks }}</p>
                        <button class="btn btn-3d-small" onclick="view3DStructure('{{ results.input_sequences.bacteria.protein_id }}', 'Bacterial')">
                            <i class="fas fa-cube"></i> View 3D Structure
                        </button>
                    </div>
                </div>
            </section>

            <!-- Alignment Summary -->
            <section class="results-section">
                <h2>Alignment Summary</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value">{{ results.alignment_summary.filtered_alignments }}</span>
                        <span class="stat-label">High-Quality Alignments</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">{{ "%.1f"|format(results.alignment_summary.total_human_aa_aligned / results.input_sequences.human.length_aa * 100) }}%</span>
                        <span class="stat-label">Human Coverage</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">{{ "%.1f"|format(results.alignment_summary.total_bact_aa_aligned / results.input_sequences.bacteria.length_aa * 100) }}%</span>
                        <span class="stat-label">Bacteria Coverage</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">{{ "%.3f"|format(results.alignment_summary.best_avg_similarity) }}</span>
                        <span class="stat-label">Best Similarity</span>
                    </div>
                </div>
            </section>

            <!-- LLM Analysis -->
            {% if results.llm_analysis and not results.llm_analysis.get('error') %}
            <section class="results-section llm-section">
                <h2><i class="fas fa-robot"></i> LLM Biological Interpretation</h2>
                
                <div class="badges-row">
                    <span class="badge {{ 'badge-high' if results.llm_analysis.alignment_quality == 'High' else 'badge-medium' if results.llm_analysis.alignment_quality == 'Medium' else 'badge-low' }}">
                        Quality: {{ results.llm_analysis.alignment_quality }}
                    </span>
                    <span class="badge badge-info">
                        Confidence: {{ results.llm_analysis.confidence_score }}%
                    </span>
                    <span class="badge {{ 'badge-success' if results.llm_analysis.false_positive_risk == 'Low' else 'badge-warning' if results.llm_analysis.false_positive_risk == 'Medium' else 'badge-danger' }}">
                        FP Risk: {{ results.llm_analysis.false_positive_risk }}
                    </span>
                </div>

                <div class="interpretation-box">
                    <h3>Relationship: {{ results.llm_analysis.biological_interpretation.relationship_type.replace('_', ' ') }}</h3>
                    <p>{{ results.llm_analysis.biological_interpretation.evidence_summary }}</p>
                    
                    <div class="evidence-grid">
                        <div class="evidence-for">
                            <h4><i class="fas fa-check"></i> Evidence For</h4>
                            <ul>
                                {% for evidence in results.llm_analysis.biological_interpretation.key_evidence_for %}
                                <li>{{ evidence }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="evidence-against">
                            <h4><i class="fas fa-times"></i> Evidence Against</h4>
                            <ul>
                                {% for evidence in results.llm_analysis.biological_interpretation.key_evidence_against %}
                                <li>{{ evidence }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <div class="conclusion-box">
                        <h4>Conclusion</h4>
                        <p>{{ results.llm_analysis.conclusion }}</p>
                    </div>
                </div>
            </section>
            {% endif %}

            <!-- Detailed Alignments -->
            <section class="results-section">
                <h2>Detailed Alignments</h2>
                <div class="alignments-list">
                    {% for alignment in results.alignments[:5] %}
                    <div class="alignment-card">
                        <div class="alignment-header">
                            <h3>Alignment #{{ alignment.alignment_rank }}</h3>
                            <span class="alignment-score">Score: {{ "%.3f"|format(alignment.smith_waterman_score) }}</span>
                        </div>
                        <div class="alignment-details">
                            <div class="detail-item">
                                <span class="detail-label">Avg Similarity</span>
                                <span class="detail-value">{{ "%.3f"|format(alignment.avg_cosine_similarity) }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Continuity</span>
                                <span class="detail-value">{{ "%.0f"|format(alignment.continuity * 100) }}%</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Chunks Aligned</span>
                                <span class="detail-value">{{ alignment.num_chunks_aligned }}</span>
                            </div>
                        </div>
                        <div class="region-info">
                            <div class="region human-region">
                                <strong>Human:</strong> {{ alignment.human_region.start }}-{{ alignment.human_region.end }} ({{ alignment.human_region.length_aa }} aa)
                            </div>
                            <div class="region bacteria-region">
                                <strong>Bacteria:</strong> {{ alignment.bacteria_region.start }}-{{ alignment.bacteria_region.end }} ({{ alignment.bacteria_region.length_aa }} aa)
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Download Section -->
            <section class="download-section">
                <a href="{{ url_for('download_protein_results', result_id=result_id) }}" class="btn btn-primary">
                    <i class="fas fa-download"></i> Download Full Results (JSON)
                </a>
            </section>
        </div>
    </main>

    <!-- 3D Structure Modal -->
    <div id="structureModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cube"></i> <span id="modalTitle">3D Protein Structure</span></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="structureLoading" class="structure-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading structure from AlphaFold...</p>
                </div>
                <div id="structureError" class="structure-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <p id="structureErrorText"></p>
                </div>
                <div id="viewer3d" class="viewer-3d" style="display: none;"></div>
                <div id="structureInfo" class="structure-info" style="display: none;">
                    <div class="info-row">
                        <span class="info-label">Protein:</span>
                        <span id="infoProteinName" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Organism:</span>
                        <span id="infoOrganism" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">UniProt ID:</span>
                        <span id="infoUniprotId" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Source:</span>
                        <span id="infoSource" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Avg pLDDT:</span>
                        <span id="infoPlddtScore" class="info-value"></span>
                    </div>
                    <div class="plddt-legend">
                        <span class="legend-title">pLDDT Confidence:</span>
                        <div class="legend-scale">
                            <span class="legend-item"><span class="color-box" style="background: #0053D6;"></span> Very High (>90)</span>
                            <span class="legend-item"><span class="color-box" style="background: #65CBF3;"></span> High (70-90)</span>
                            <span class="legend-item"><span class="color-box" style="background: #FFDB13;"></span> Low (50-70)</span>
                            <span class="legend-item"><span class="color-box" style="background: #FF7D45;"></span> Very Low (<50)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetView()">
                    <i class="fas fa-undo"></i> Reset View
                </button>
                <button class="btn btn-secondary" onclick="toggleSpin()">
                    <i class="fas fa-sync"></i> Toggle Spin
                </button>
                <button class="btn btn-primary" onclick="closeModal()">
                    <i class="fas fa-check"></i> Done
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container footer-content">
            <div class="footer-brand">
                <h3>BioSci</h3>
                <p class="copyright">Â© 2024 BioSci AI. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/particles.js') }}"></script>
    <script src="{{ url_for('static', filename='js/protein-viewer.js') }}"></script>
</body>

</html>
